<!doctype html>
<html lang="en">
    <link rel="icon" type="image/x-icon" href="/public/images/favicon.png">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Guilds</title>
        <link
        href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito+Sans:wght@700&display=swap"
        rel="stylesheet"
    />
        <style>
            body {
                display: block;
                font-family:
                    Nunito Sans,
                    sans-serif;
                margin: 0;
                padding: 0;
                background-image: url("images/checkers.png");
                background-size: cover;
                justify-content: center;
                align-items: center;
                height: 100vh;
                text-align: center;
            }
            .container {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px;
                max-width: 925px;
                height: 250px;
                width: 100%;
                background-color: #a30000;
                border-radius: 20px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                color: #fff;
                text-align: center;
                margin-left: 200px;
                margin-top: 100px;
                box-shadow: inset 0 -10px rgba(0, 0, 0, 0.2);
            }

            .search-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 20px;
                max-width: 925px;
                width: 100%;
                height: 250px;
                background-color: #a30000;
                border-radius: 20px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                color: #fff;
                text-align: center;
                margin-left: 1400px;
                margin-top: -290px;
                box-shadow: inset 0 -10px rgba(0, 0, 0, 0.2);
            }

            .nav-button {
                    background-color: #d40000;
                    display: flex;
                    justify-content: space-around;
                    margin-top: 20px;
                    width: 100%;
                    font-family: "Titan One", sans-serif;
                }
                .nav-button a {
                    text-decoration: none;
                    color: #fff;
                    background-color: #c20000;
                    padding: 10px 40px;
                    border-radius: 5px;
                    font-family: "Nunito Sans", sans-serif;
                    font-weight: 700;
                    font-size: 16px;
                    transition: background-color 0.3s;
                }
                .nav-button a:hover {
                    background-color: #a30000;
                }





                
                .nav-bar {
                    padding-right: 15px;
                    padding-left: 15px;
                    background-color: rgb(178, 9, 9);
                }
                .navdiv {
                    display: flex;
                    align-items: center;
                    background-color: #8B0000;
                    border-bottom: #6B0000 8px solid;
                    height: 100px;
                    font-family: 'Titan One', sans-serif;
                }
                .navdiv h1 {
                    color: #fff;
                }
                .logo a {
                    margin-left: 15px;
                    font-size: 35px;
                    color: #fff;
                    font-family: "Titan One", sans-serif;
                    text-decoration: none;
                }
                button {
                    background-color: #9d0000;
                    margin-left: 10px;
                    border-radius: 10px;
                    border-color: #fff;
                    padding: 10px;
                    width: 90px;
                    text-decoration: none;
                }
                button a {
                    color: white;
                    font-family: "Titan One", sans-serif;
                    font-size: 15px;
                    text-decoration: none;
                }
        </style>
    </head>
    <body>
        <nav class="navbar">
            <div class="navdiv">
                <div class="logo"><a href="index.html">Rojolet</a></div>
                <ul>
                    <button><a href="stats.html">Stats</a></button>
                    <button><a href="chat.html">Chat</a></button>
                    <button><a href="market.html">Market</a></button>
                    <button><a href="blooks.html">Blooks</a></button>
                    <button><a href="lobby.html">Games</a></button>
                    <button><a href="#">Clans</a></button>
                    <button><a href="admin.html">Panel</a></button>
                </ul>
            </div>
        </nav>


        <!-- Form to create a new guild -->
         <div class="container">
        <div>
            <h2 style="font-family: 'Titan One', sans-serif; font-size: 40px;">Create Guild</h2>
            <input 
            type="text" 
            id="guildName" 
            placeholder="Guild Name" 
            style="height: 30px;flex: 1; padding: 10px; border: 1px solid #8B0000; border-radius: 10px; background-color: #6B0000; color: white; font-size: 15px; font-family: 'Titan One', sans-serif;"/>
            <input
                type="text"
                id="guildDescription"
                placeholder="Guild Description"
                style="height: 30px;flex: 1; padding: 10px; border: 1px solid #8B0000; border-radius: 10px; background-color: #6B0000; color: white; font-size: 15px; font-family: 'Titan One', sans-serif;"
            />
            <input
                type="text"
                id="guildImage"
                placeholder="Guild Cover Image URL"
                style="height: 30px;flex: 1; padding: 10px; border: 1px solid #8B0000; border-radius: 10px; background-color: #6B0000; color: white; font-size: 15px; font-family: 'Titan One', sans-serif;"
            />
            <button onclick="createGuild()" style="color: #fff; font-family: 'Titan One', sans-serif;">Create Guild</button>
        </div>
    </div>
       <div class="search-container">
        <h2 style="font-family: 'Titan One', sans-serif; font-size: 40px;">Search for Clans</h2>
       </div>
       

        <!-- List of available guilds -->
        <div>
            <div id="guildList"></div>
        </div>

        <!-- Guild management section for the owner -->
        <div id="manageGuild" style="display: none">
            <h2>Manage Your Guild</h2>
            <input type="hidden" id="guildId" />
            <input
                type="text"
                id="editGuildName"
                placeholder="Edit Guild Name"
            />
            <input
                type="text"
                id="editGuildDescription"
                placeholder="Edit Guild Description"
            />
            <input
                type="text"
                id="editGuildImage"
                placeholder="Edit Guild Cover Image URL"
            />
            <button onclick="saveGuildChanges()">Save Changes</button>
            <h3>Members</h3>
            <div id="guildMembers"></div>
        </div>

        <!-- Firebase SDK v8.x -->
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

        <script>
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCOIKlP9YhtX9xa5aoggmsrWwavlW-XuzI",
                authDomain: "cosmik-7c124.firebaseapp.com",
                databaseURL: "https://cosmik-7c124-default-rtdb.firebaseio.com",
                projectId: "cosmik-7c124",
                storageBucket: "cosmik-7c124.appspot.com",
                messagingSenderId: "412506429662",
                appId: "1:412506429662:web:9ca3e17199297df7384a4f",
                measurementId: "G-R7K0LTHCK3",
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Function to get username from cookies
            function getUsernameFromCookies() {
                const cookies = document.cookie.split("; ");
                const usernameCookie = cookies.find((cookie) =>
                    cookie.startsWith("username="),
                );
                return usernameCookie
                    ? decodeURIComponent(usernameCookie.split("=")[1])
                    : null;
            }

            // Function to create a guild
            function createGuild() {
                const guildName = document.getElementById("guildName").value;
                const guildDescription =
                    document.getElementById("guildDescription").value;
                const guildImage = document.getElementById("guildImage").value;

                const user = firebase.auth().currentUser;
                const creatorName = getUsernameFromCookies();

                if (user && guildName && guildDescription && guildImage) {
                    db.collection("guilds")
                        .add({
                            name: guildName,
                            description: guildDescription,
                            image: guildImage,
                            creator: user.uid,
                            creatorName: creatorName,
                        })
                        .then(() => {
                            alert("Guild created successfully!");
                            loadGuilds(); // Refresh the guild list after creation
                        })
                        .catch((error) => {
                            console.error("Error creating guild: ", error);
                        });
                } else {
                    alert(
                        "Please fill in all fields and ensure you are logged in.",
                    );
                }
            }

            // Function to load and display all available guilds
            function loadGuilds() {
                const guildList = document.getElementById("guildList");
                guildList.innerHTML = "";

                db.collection("guilds")
                    .get()
                    .then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            const guild = doc.data();
                            guildList.innerHTML += `
                        <div id="guild-${doc.id}">
                            <h3>${guild.name}</h3>
                            <p>${guild.description}</p>
                            <img src="${guild.image}" alt="${guild.name}" width="100">
                            <p>Created by: ${guild.creatorName}</p>
                            <button onclick="viewGuild('${doc.id}', '${guild.creator}')">View Guild</button>
                            <button onclick="joinGuild('${doc.id}')" id="join-${doc.id}" style="display:none;">Join Guild</button>
                        </div>
                        <hr>
                    `;
                        });
                    })
                    .catch((error) => {
                        console.error("Error loading guilds: ", error);
                    });
            }

            // Function to view and manage the guild
            function viewGuild(guildId, creatorId) {
                const user = firebase.auth().currentUser;

                if (user) {
                    if (user.uid === creatorId) {
                        // Show guild management if the user is the owner
                        document.getElementById("manageGuild").style.display =
                            "block";
                        document.getElementById("guildId").value = guildId;

                        // Load guild details for editing
                        db.collection("guilds")
                            .doc(guildId)
                            .get()
                            .then((doc) => {
                                if (doc.exists) {
                                    const guild = doc.data();
                                    document.getElementById(
                                        "editGuildName",
                                    ).value = guild.name;
                                    document.getElementById(
                                        "editGuildDescription",
                                    ).value = guild.description;
                                    document.getElementById(
                                        "editGuildImage",
                                    ).value = guild.image;

                                    loadGuildMembers(guildId);
                                }
                            })
                            .catch((error) => {
                                console.error("Error loading guild: ", error);
                            });
                    } else {
                        // If not the owner, show the "Join Guild" button and hide management
                        document.getElementById(
                            `join-${guildId}`,
                        ).style.display = "inline";
                        document.getElementById("manageGuild").style.display =
                            "none";
                    }
                } else {
                    alert("You must be logged in to view or join a guild.");
                }
            }

            // Function to join a guild
            function joinGuild(guildId) {
                const user = firebase.auth().currentUser;

                if (user) {
                    db.collection("guilds")
                        .doc(guildId)
                        .collection("members")
                        .add({
                            uid: user.uid,
                            username: getUsernameFromCookies(),
                        })
                        .then(() => {
                            alert("Joined guild successfully!");
                            // Optionally reload the guild list or update the UI
                        })
                        .catch((error) => {
                            console.error("Error joining guild: ", error);
                        });
                } else {
                    alert("You must be logged in to join a guild.");
                }
            }

            // Function to load guild members
            function loadGuildMembers(guildId) {
                const guildMembersDiv = document.getElementById("guildMembers");
                guildMembersDiv.innerHTML = "";

                db.collection("guilds")
                    .doc(guildId)
                    .collection("members")
                    .get()
                    .then((querySnapshot) => {
                        querySnapshot.forEach((doc) => {
                            const member = doc.data();
                            guildMembersDiv.innerHTML += `
                        <div>
                            <p>${member.username}</p>
                            <button onclick="kickMember('${guildId}', '${doc.id}')">Kick</button>
                        </div>
                    `;
                        });
                    })
                    .catch((error) => {
                        console.error("Error loading members: ", error);
                    });
            }

            // Function to save guild changes
            function saveGuildChanges() {
                const guildId = document.getElementById("guildId").value;
                const updatedName =
                    document.getElementById("editGuildName").value;
                const updatedDescription = document.getElementById(
                    "editGuildDescription",
                ).value;
                const updatedImage =
                    document.getElementById("editGuildImage").value;

                if (
                    guildId &&
                    updatedName &&
                    updatedDescription &&
                    updatedImage
                ) {
                    db.collection("guilds")
                        .doc(guildId)
                        .update({
                            name: updatedName,
                            description: updatedDescription,
                            image: updatedImage,
                        })
                        .then(() => {
                            alert("Guild updated successfully!");
                            loadGuilds(); // Refresh the guild list after updating
                        })
                        .catch((error) => {
                            console.error("Error updating guild: ", error);
                        });
                } else {
                    alert("Please fill in all fields.");
                }
            }

            // Function to kick a member from a guild
            function kickMember(guildId, memberId) {
                db.collection("guilds")
                    .doc(guildId)
                    .collection("members")
                    .doc(memberId)
                    .delete()
                    .then(() => {
                        alert("Member kicked successfully!");
                        loadGuildMembers(guildId); // Refresh the member list
                    })
                    .catch((error) => {
                        console.error("Error kicking member: ", error);
                    });
            }

            // Load available guilds on page load
            window.onload = function () {
                loadGuilds();
            };
        </script>
    </body>
</html>
