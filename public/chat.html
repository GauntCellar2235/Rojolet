<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chat | Rojolet</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Titan+One&family=Nunito+Sans:wght@700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Nunito Sans", sans-serif;
                margin: 0;
                padding: 0;
                background-image: url("images/checkers.png");
                background-size: cover;
                background-position: center;
                display: flex;
                height: 100vh;
                justify-content: center;
                align-items: center;
            }
            .sidebar {
            width: 30%;
            Padding: 20px;
            color: darkred;
            display: flex;
            flex-direction: column;
            justifeied-content: center;
            align-items: center;
            background-color: #8B0000;
            box-shadow: inset -13px 0 0px -5px rgba(84, 6, 1);
            }
            .sidebar h1
            
            .chat-container {
                display: flex;
                flex-direction: column;
                height: 80vh;
                width: 100%;
                max-width: 600px;
                background-image: url("images/checkers.png");
                border: 0px solid darkred;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            }
            .messages {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                border-bottom: 3px solid darkred;
            }
            .messages .message {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
            }
            .messages .message .profile-picture {
                margin-right: 10px;
            }
            .messages .message .username {
                font-family: "Titan One", cursive;
                font-size: 16px;
                margin-right: 10px;
            }
            .messages .message .text {
                font-family: "Nunito Sans", sans-serif;
                font-weight: 700;
            }
            .messages .message .timestamp {
                font-family: "Nunito Sans", sans-serif;
                font-size: 12px;
                color: #aaa;
                margin-left: 10px;
            }
            .input-container {
                padding: 10px;
                border-top: 1px solid darkred;
                display: flex;
            }
            .input-container input {
                flex: 1;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                color: darkred;
            }
            .input-container button {
                width: 80px;
                padding: 10px;
                border: none;
                background-color: darkred;
                color: white;
                border-radius: 4px;
                cursor: pointer;
                margin-left: 10px;
                transition: background-color 0.3s ease;
            }
            .input-container button:hover {
                background-color: #d40000;
            }
            .badge {
                width: 30px;
                height: 30px;
                margin-right: 5px;
                border-radius: 50%;
                display: inline-block;
            }
        </style>
    </head>
    <body>
        <div class="chat-container">
            <div class="messages" id="messages"></div>
            <div class="input-container">
                <input
                    id="messageInput"
                    type="text"
                    placeholder="Type your message here..."
                    maxlength="2500"
                />
                <button id="sendButton">Send</button>
            </div>
        </div>

        <audio
            id="notificationSound"
            src="sounds/ping.mp3"
            preload="auto"
        ></audio>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
            import {
                getDatabase,
                ref,
                onChildAdded,
                push,
            } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";
            import {
                getAuth,
                onAuthStateChanged,
            } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-auth.js";

            const firebaseConfig = {
                apiKey: "AIzaSyCOIKlP9YhtX9xa5aoggmsrWwavlW-XuzI",
                authDomain: "cosmik-7c124.firebaseapp.com",
                databaseURL: "https://cosmik-7c124-default-rtdb.firebaseio.com",
                projectId: "cosmik-7c124",
                storageBucket: "cosmik-7c124.appspot.com",
                messagingSenderId: "412506429662",
                appId: "1:412506429662:web:9ca3e17199297df7384a4f",
                measurementId: "G-R7K0LTHCK3",
            };

            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            const auth = getAuth(app);

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2)
                    return decodeURIComponent(parts.pop().split(";").shift());
                return null;
            }

            function safeJsonParse(cookieValue) {
                try {
                    if (
                        typeof cookieValue === "string" &&
                        cookieValue.startsWith("[")
                    ) {
                        return JSON.parse(cookieValue);
                    }
                    return cookieValue; // Return as-is if not JSON string
                } catch (e) {
                    console.error("Failed to parse JSON from cookie", e);
                    return [];
                }
            }

            const username = getCookie("username") || "Guest";
            const profilePicture =
                getCookie("profilePicture") || "https://via.placeholder.com/40";
            const badges = safeJsonParse(getCookie("badges")) || [];

            const messagesContainer = document.getElementById("messages");
            const messageInput = document.getElementById("messageInput");
            const sendButton = document.getElementById("sendButton");
            const notificationSound =
                document.getElementById("notificationSound");

            let userInteracted = false;
            document.body.addEventListener("click", () => {
                userInteracted = true;
            });

            function addMessage(
                username,
                profilePicture,
                badges,
                text,
                timestamp,
            ) {
                const messageDiv = document.createElement("div");
                messageDiv.classList.add("message");

                if (!Array.isArray(badges)) {
                    badges = [];
                }

                const badgeElements = badges
                    .map(
                        (badge) =>
                            `<img src="${badge}" class="badge" alt="Badge">`,
                    )
                    .join("");

                messageDiv.innerHTML = `
                    <img src="${profilePicture}" class="profile-picture" width="40" height="40">
                    <div>
                        <div class="username">${username}</div>
                        ${badgeElements}
                        <div class="text">${text}</div>
                        <div class="timestamp">${timestamp}</div>
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                if (userInteracted && text.includes(`@${username}`)) {
                    notificationSound.play().catch((error) => {
                        console.error("Error playing sound:", error);
                    });
                }
            }

            function loadMessages() {
                const messagesRef = ref(database, "messages");
                onChildAdded(messagesRef, (snapshot) => {
                    const message = snapshot.val();
                    addMessage(
                        message.username,
                        message.profilePicture || profilePicture,
                        message.badges || [],
                        message.text,
                        message.timestamp,
                    );
                });
            }

            loadMessages();

            sendButton.addEventListener("click", () => {
                const text = messageInput.value.trim();
                if (text) {
                    const timestamp = new Date().toLocaleString();
                    const message = {
                        username,
                        profilePicture,
                        badges,
                        text,
                        timestamp,
                    };
                    const messagesRef = ref(database, "messages");
                    push(messagesRef, message)
                        .then(() => {
                            messageInput.value = "";
                            if (userInteracted) {
                                notificationSound.play().catch((error) => {
                                    console.error(
                                        "Error playing sound:",
                                        error,
                                    );
                                });
                            }
                        })
                        .catch((error) =>
                            console.error("Error adding message:", error),
                        );
                }
            });

            messageInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    sendButton.click();
                }
            });

            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    console.error("User not authenticated");
                }
            });
        </script>
    </body>
</html>
}
