<!doctype html>
<html lang="en">
    <link rel="icon" type="image/x-icon" href="/public/images/favicon.png">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>New Minigame Area</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            #gameContainer {
                position: relative;
                width: 100vw;
                height: 100vh;
                background-color: #a8d5a8;
                overflow: hidden;
            }

            .player {
                position: absolute;
                width: 50px;
                height: 50px;
                background-size: cover;
                background-position: center;
                transition: all 0.1s linear;
            }

            .projectile {
                position: absolute;
                width: 10px;
                height: 10px;
                background-color: red;
                border-radius: 50%;
            }

            #healthBar {
                position: absolute;
                top: 10px;
                left: 10px;
                width: 200px;
                height: 20px;
                background-color: lightgray;
                border-radius: 10px;
            }

            #health {
                height: 100%;
                background-color: green;
                border-radius: 10px;
            }

            .tree {
                position: absolute;
                width: 50px;
                height: 50px;
                background-color: #228b22;
                border-radius: 25px;
            }

            .dirt {
                position: absolute;
                width: 100px;
                height: 100px;
                background-color: #8b4513;
            }

            .rock {
                position: absolute;
                width: 50px;
                height: 50px;
                background-color: gray;
                border-radius: 50%;
            }

            #countdownContainer {
                position: fixed;
                top: 10px;
                right: 10px;
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 10px;
                border-radius: 5px;
            }

            #playerListContainer {
                position: fixed;
                bottom: 10px;
                left: 10px;
                background-color: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 10px;
                border-radius: 5px;
                max-height: 200px;
                overflow-y: auto;
                width: 200px;
            }
        </style>
    </head>
    <body>
        <div id="gameContainer">
            <div id="healthBar">
                <div id="health"></div>
            </div>
            <div class="tree" style="left: 200px; top: 300px"></div>
            <div class="dirt" style="left: 400px; top: 500px"></div>
            <div class="rock" style="left: 600px; top: 200px"></div>
        </div>

        <div id="countdownContainer">
            Time Remaining: <span id="countdown">30</span> seconds
        </div>

        <div id="playerListContainer">
            <h3>Lobby Players</h3>
            <ul id="playerList"></ul>
        </div>

        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyCOIKlP9YhtX9xa5aoggmsrWwavlW-XuzI",
                authDomain: "cosmik-7c124.firebaseapp.com",
                projectId: "cosmik-7c124",
                storageBucket: "cosmik-7c124.appspot.com",
                messagingSenderId: "412506429662",
                appId: "1:412506429662:web:9ca3e17199297df7384a4f",
                measurementId: "G-R7K0LTHCK3",
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            let playerElement = null;
            let currentLobbyId = null;
            let position = { x: 100, y: 100 };
            let health = 100;
            let lastDirection = { x: 0, y: -10 };
            let countdownInterval = null;
            const countdownDuration = 30; // Countdown duration in seconds

            function getUserFromCookies() {
                const cookie = document.cookie
                    .split("; ")
                    .find((row) => row.startsWith("username="));
                if (cookie) {
                    return cookie.split("=")[1];
                }
                return null;
            }

            async function loadGameArea() {
                const username = getUserFromCookies();
                if (!username) {
                    alert("Username not found. Please log in.");
                    return;
                }

                try {
                    const userDoc = await db
                        .collection("users")
                        .doc(username)
                        .get();
                    if (!userDoc.exists) {
                        alert("User document does not exist.");
                        return;
                    }

                    const profilePicture = userDoc.data()?.profilePicture;

                    if (profilePicture) {
                        createPlayer(username, profilePicture, position);
                    } else {
                        alert("No profile picture selected.");
                        return;
                    }

                    currentLobbyId = prompt("Enter Lobby ID to join:");
                    if (!currentLobbyId) {
                        alert("Lobby ID is required.");
                        return;
                    }

                    const lobbyRef = db
                        .collection("lobbies")
                        .doc(currentLobbyId);
                    const lobbyDoc = await lobbyRef.get();

                    if (!lobbyDoc.exists) {
                        alert(
                            "Lobby does not exist. Please enter a valid Lobby ID.",
                        );
                        return;
                    }

                    await joinLobby(lobbyRef, username, profilePicture);
                    listenToPlayerMovements(lobbyRef);
                    startCountdown(lobbyRef);
                } catch (error) {
                    console.error("Error loading game area:", error);
                    alert("An error occurred while loading the game.");
                }
            }

            async function joinLobby(lobbyRef, username, profilePicture) {
                try {
                    const lobbyDoc = await lobbyRef.get();
                    let participants = lobbyDoc.data()?.participants || [];

                    const existingPlayer = participants.find(
                        (p) => p.username === username,
                    );
                    if (!existingPlayer) {
                        participants.push({
                            username,
                            position,
                            profilePicture,
                            health,
                        });
                        await lobbyRef.update({ participants });
                    }

                    participants.forEach((participant) => {
                        if (participant.username !== username) {
                            createPlayer(
                                participant.username,
                                participant.profilePicture,
                                participant.position,
                            );
                        }
                    });

                    updatePlayerList(participants);
                } catch (error) {
                    console.error("Error joining lobby:", error);
                    alert("An error occurred while joining the lobby.");
                }
            }

            function createPlayer(username, profilePicture, position) {
                const gameContainer = document.getElementById("gameContainer");
                let existingPlayerElement = document.getElementById(username);

                if (!existingPlayerElement) {
                    const newPlayerElement = document.createElement("div");
                    newPlayerElement.id = username;
                    newPlayerElement.classList.add("player");
                    newPlayerElement.style.backgroundImage = `url('${profilePicture}')`;
                    newPlayerElement.style.left = `${position.x}px`;
                    newPlayerElement.style.top = `${position.y}px`;
                    gameContainer.appendChild(newPlayerElement);

                    if (username === getUserFromCookies()) {
                        playerElement = newPlayerElement;
                    }
                }
            }

            function movePlayer(dx, dy) {
                const newX = position.x + dx;
                const newY = position.y + dy;

                if (!checkCollision(newX, newY)) {
                    position.x = newX;
                    position.y = newY;
                    lastDirection = { x: dx, y: dy };
                    updatePlayerPosition();
                }
            }

            function checkCollision(x, y) {
                const obstacles = document.querySelectorAll(
                    ".tree, .dirt, .rock",
                );
                for (const obstacle of obstacles) {
                    const rect1 = {
                        left: x,
                        right: x + 50,
                        top: y,
                        bottom: y + 50,
                    };
                    const rect2 = obstacle.getBoundingClientRect();

                    if (
                        rect1.left < rect2.right &&
                        rect1.right > rect2.left &&
                        rect1.top < rect2.bottom &&
                        rect1.bottom > rect2.top
                    ) {
                        return true;
                    }
                }
                return false;
            }

            function updatePlayerPosition() {
                if (playerElement) {
                    playerElement.style.left = `${position.x}px`;
                    playerElement.style.top = `${position.y}px`;
                    updatePlayerInFirestore();
                }
            }

            function updatePlayerInFirestore() {
                const username = getUserFromCookies();
                const lobbyRef = db.collection("lobbies").doc(currentLobbyId);

                lobbyRef.update({
                    participants: firebase.firestore.FieldValue.arrayUnion({
                        username,
                        position,
                        health,
                    }),
                });
            }

            function updatePlayerList(players) {
                const playerList = document.getElementById("playerList");
                playerList.innerHTML = "";

                players.forEach((player) => {
                    const li = document.createElement("li");
                    li.textContent = player.username;
                    playerList.appendChild(li);
                });
            }

            function startCountdown(lobbyRef) {
                const countdownElement = document.getElementById("countdown");
                let timeLeft = countdownDuration;

                countdownInterval = setInterval(async () => {
                    countdownElement.textContent = timeLeft;

                    if (timeLeft <= 0) {
                        clearInterval(countdownInterval);
                        countdownElement.textContent = "0";
                        alert("The game is starting now!");
                        // Add code to start the game
                        return;
                    }

                    timeLeft--;
                }, 1000);
            }

            loadGameArea();
        </script>
    </body>
</html>
